rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Los usuarios pueden crear su propio perfil y solo ellos pueden leerlo o actualizarlo.
    match /users/{userId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
    }

    // Reglas para la colecci√≥n de institutos
    match /institutes/{instituteId} {
      // Cualquiera autenticado puede crear un instituto (durante el registro).
      allow create: if request.auth != null;

      // Solo los miembros del instituto pueden leer o actualizar los datos del instituto.
      allow read, update: if request.auth != null 
                          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.instituteId == instituteId;
    }

    // Reglas para todas las subcolecciones dentro de un instituto (people, sessions, etc.)
    match /institutes/{instituteId}/{collection}/{docId} {
      // Solo los miembros del instituto pueden leer o escribir en sus subcolecciones.
      allow read, write: if request.auth != null 
                         && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.instituteId == instituteId;
    }
  }
}
